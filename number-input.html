<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">

<dom-module id="number-input">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      input {
        @apply --datetime-input;
      }
      input:hover,
      input:focus {
        @apply --datetime-focus;
      }
    </style>
    <input id="input" type="text" value="{{_value::input}}" placeholder="[[placeholder]]" on-keydown="_checkKeycode" on-keyup="_stopIncrem" disabled="[[disabled]]"></input>
  </template>

  <script>
  /**
   * `number-input`
   * A number input that prevents false input to be propagated and pads the value
   *
   *   @customElement
   *   @polymer
   *
   *   @demo demo/number-input.html
   */
    class NumberInput extends Polymer.Element {

      static get is() {
        return 'number-input';
      }

      static get properties() {
        return {
          /**
           * minimal input
           * @type {number}
           */
          min: {
            type: Number
          },
          /**
           * maximal input
           * @type {number}
           */
          max: {
            type: Number
          },
          /**
           * step for changing the input
           * @type {number}
           */
          step: {
            type: Number,
            value: 1
          },

          padLength: {
            type: Number,
            reflectToAttribute: true
          },

          placeholder: {
            type: String
          },

          disabled: {
            type: Boolean
          },

          value: {
            type: Number,
            notify: true,
            observer: 'valueChanged'
          },

          _value: {
            type: String,
            observer: '_valueChanged'
          }
        }
      }

      static get observers() {
        return [
          '_computeWidth(padLength, placeholder, min, max)'
        ]
      }

      _pad(n, padLength) {
        let str = '' + n;
        let targetLength = padLength || this.padLength || (this.placeholder && this.placeholder.length) || Math.log10(+n);
        const padString = '0';
        if (str.length > targetLength) {
          return str;
        } else {
          if (n < 0) {
            str = str.slice(1);
          }
          targetLength = targetLength - str.length;
          for (let i = 0; i < targetLength; i++) {
            str = padString + str;
          }
          if (n < 0) {
            str = '-' + str;
          }
          return str;
        }
      }

      _valueChanged(_value) {
        let value = Number(_value);

        const min = this.min;
        const max = this.max;
        let changed = false;

        if (isNaN(value)) {
          value = Number(this.value);
          changed = true;
        } else if (min !== undefined && value < min) {
          value = min;
          changed = true;
        } else if (max !== undefined && value > max) {
          value = max;
          changed = true;
        }

        if (isNaN(value)) {
          return;
        } else if (changed === true) {
          this._value = this._pad(value);
        } else {
          this.value = value;
        }
      }

      valueChanged(value) {
        if (value === undefined) return;

        if (this.min !== undefined && value < this.min) {
          this.value = this.min;
          return;
        }
        if (this.max !== undefined && value > this.max) {
          this.value = this.max;
          return;
        }
        this._value = this._pad(value);
        this.padLength = this._value.replace(/\.|-/, '').length;
      }

      _checkKeycode(e) {
        if (!e.target) {
          if (e && e.preventDefault) e.preventDefault();
          return;
        }
        // up or down key press
        const step = this.step || 1;
        const inc = (e.keyCode === 38) ? step : (e.keyCode === 40 ? -step : 0);
        if (inc !== 0) {
          this._startIncrem(inc);
          return;
        }
        // left or right key press
        if (e.keyCode === 39) {
          this.dispatchEvent(new CustomEvent('focus-next-input'));
          return;
        }

        if (e.keyCode === 37) {
          this.dispatchEvent(new CustomEvent('focus-previous-input'));
          return;
        }
      }

      _startIncrem(step) {
        this._stopIncrem();
        this._increm(step);
        this._activeJob = setInterval(() => {
          this._increm(step);
        }, 150);
      }

      _stopIncrem() {
        if (this._activeJob) {
          clearInterval(this._activeJob);
        }
      }

      _increm(step) {
        if (!step) return;
        const min = this.min;
        const max = this.max;
        step = step || this.step || 1;
        const value = this._safeAdd(this._value, step);
        this.value = (max === undefined || value <= max) ? ((min === undefined || value >= min) ? value : min) : max;
      }

      _safeAdd(a, b) {

        let endSign, operator;
        a = Number(a || 0);
        b = Number(b || 0);

        if (a < 0 && b < 0) {
          endSign = '-';
          operator = 1;
        } else if (a < 0 || b < 0) {
          if (-a > b) {
            endSign = '-';
          } else {
            endSign = '+';
          }
          if (Math.abs(a) < Math.abs(b)) {
            let tmp = a;
            a = b;
            b = tmp;
          }
          operator = -1;
        } else {
          endSign = '+';
          operator = 1;
        }

        a = '' + a;
        b = '' + b;

        if (a[0] === '-') {
          a = a.slice(1, a.length);
        }

        if (b[0] === '-') {
          b = b.slice(1, b.length);
        }

        if (a.indexOf('.') === -1) {
          a += '.0'
        }
        if (b.indexOf('.') === -1) {
          b += '.0'
        }

        let aWhole = a.slice(0, a.indexOf('.'));
        let bWhole = b.slice(0, b.indexOf('.'));
        let aPart = a.slice(a.indexOf('.') + 1);
        let bPart = b.slice(b.indexOf('.') + 1);
        let wholeLength = Math.max(aWhole.length, bWhole.length);
        let partLength = Math.max(aPart.length, bPart.length);

        while (aWhole.length < wholeLength) {
          aWhole = '0' + aWhole;
        }
        while (bWhole.length < wholeLength) {
          bWhole = '0' + bWhole;
        }
        while (aPart.length < partLength) {
          aPart += '0';
        }
        while (bPart.length < partLength) {
          bPart += '0';
        }

        a = aWhole + '.' + aPart;
        b = bWhole + '.' + bPart;

        let valueString = '';
        let carry = 0, tmp = 0;
        let i = a.length - 1;

        while (i >= 0) {
          if (a[i] === '.') {
            valueString = '.' + valueString;
          } else {
            tmp = Number(a[i] || 0) + operator * Number(b[i] || 0) + carry;
            valueString = Math.round((tmp + 10) % 10) + valueString;
            carry = Math.floor(tmp / 10);
          }
          i--;
        }
        return Number(endSign + carry + valueString);
      }

      _computeWidth(padLength, placeholder, min, max) {
        if (padLength === undefined && placeholder === undefined && min === undefined && max === undefined) {
          return;
        }
        let width;
        if (padLength) {
          width = padLength;
        }
        if (placeholder && placeholder.length > (width || 0)) {
          width = placeholder.length;
        }
        if (min) {
          let str = '' + min;
          if (str && str.length > (width || 0)) {
            width = str.length;
          }
        }
        if (max) {
          let str = '' + max;
          if (str && str.length > (width || 0)) {
            width = str.length;
          }
        }
        if (width !== undefined) {
          // IE fix
          if (navigator.userAgent.match(/Trident/i)) {
            width += 0.5;
          }
          this.$.input.style.width = width + 'ch';
        }
      }

      focus() {
        this.$.input.focus();
      }
    }
    window.customElements.define(NumberInput.is, NumberInput);
  </script>
</dom-module>
